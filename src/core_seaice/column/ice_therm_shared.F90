!  SVN:$Id: ice_therm_shared.F90 1196 2017-04-18 13:32:23Z eclare $
!=========================================================================
!
! Shared thermo variables, subroutines
!
! authors: Elizabeth C. Hunke, LANL
! modified by Zachary S. Wolff (ZSW), UCI 
! modifications 

      module ice_therm_shared

      use ice_kinds_mod
      use ice_constants_colpkg
    
      implicit none
      save

      private
      public :: calculate_Tin_from_qin, &
                surface_heat_flux, dsurface_heat_flux_dTsf, &
                planck_exponent, planck_int, planck_power, &
                Rad_calculate, rrtmg_longwave_flux, rrtmgp_longwave_flux, &
                longwave_re_emitted_flux, longwave_emitted, longwave_absorbed_reemit_flux
               

      real (kind=dbl_kind), parameter, public :: &
         ferrmax = 1.0e-2_dbl_kind    ! max allowed energy flux error (W m-2)
                                      ! recommend ferrmax < 0.01 W m-2

      real (kind=dbl_kind), parameter, public :: &
         Tmin = -100.0_dbl_kind ! min allowed internal temperature (deg C)

      logical (kind=log_kind), public :: &
         l_brine         ! if true, treat brine pocket effects

      real (kind=dbl_kind), parameter, public :: &
         hfrazilmin = 0.05_dbl_kind ! min thickness of new frazil ice (m)

      real (kind=dbl_kind), public :: &
         hi_min          ! minimum ice thickness allowed (m)

!=======================================================================

      contains

!=======================================================================
!
!  Compute the internal ice temperatures from enthalpy using
!  quadratic formula

      function calculate_Tin_from_qin (qin, Tmltk) &
               result(Tin)

      real (kind=dbl_kind), intent(in) :: &
         qin   , &              ! enthalpy
         Tmltk                  ! melting temperature at one level

      real (kind=dbl_kind) :: &
         Tin                 ! internal temperature

      ! local variables

      real (kind=dbl_kind) :: &
         aa1,bb1,cc1         ! quadratic solvers

      if (l_brine) then
         aa1 = cp_ice
         bb1 = (cp_ocn-cp_ice)*Tmltk - qin/rhoi - Lfresh 
         cc1 = Lfresh * Tmltk
         Tin =  min((-bb1 - sqrt(bb1*bb1 - c4*aa1*cc1)) /  &
                         (c2*aa1),Tmltk)

      else                ! fresh ice
         Tin = (Lfresh + qin/rhoi) / cp_ice
      endif
 
      end function calculate_Tin_from_qin
      
      
      function planck_exponent(Tsfk,wvn) &
           result(rad)
      
      
      real(kind=dbl_kind), intent(in)::&
          Tsfk, &
          wvn 
      real (kind=dbl_kind) ::&
         rad
      real (kind=dbl_kind) ::&
         D, Mv, M, Ex, V, n, Const2
     
     Const2 = 1.438786_dbl_kind
     V = Const2*wvn/Tsfk
     if (V<1.9) then
        n = 7
            
     elseif (V<2.3) then
        n = 6
      
       
     elseif (V<2.9) then
        n = 5
         
 
     elseif (V<3.9) then
        n = 4
     
     elseif (V<5.7) then
        n = 3
      
     else 
        n =2 
     endif
        
     D = 0_dbl_kind
!     M = 1_dbl_kind
         
     do M=1,n
        Mv = M*V 
        Ex = exp(-Mv)
        D = D+(Ex*(6.0_dbl_kind+Mv*(6.0_dbl_kind+Mv*(3.0_dbl_kind+Mv)))/M**4.0_dbl_kind)
        enddo    
      rad = (15.0_dbl_kind/pi**4.0_dbl_kind)*D
      
    end function planck_exponent
              
    
    function planck_power(Tsfk,wvn) &
             result(rad)
      
      
      real(kind=dbl_kind), intent(in)::&
          Tsfk, wvn
      real (kind=dbl_kind) ::&
         rad, V, Const2
     
      Const2 = 1.438786_dbl_kind
      V = Const2*wvn/Tsfk
      
      rad =((15.0_dbl_kind*V**3.0_dbl_kind)/(pi**4.0_dbl_kind))*((1.0_dbl_kind/3.0_dbl_kind)- &
      (V/8.0_dbl_kind)+(V**2.0_dbl_kind/60.0_dbl_kind)-(V**4.0_dbl_kind/5040.)+ &
      (V**6.0_dbl_kind/272160.0_dbl_kind)-(V**8.0_dbl_kind/13305600.0_dbl_kind))
      
      end function planck_power
      
         
      function Rad_calculate(wv, T) &
               result(rad)
      real (kind=dbl_kind), intent(in)::& 
          wv, & 
          T 
      real (kind=dbl_kind) ::& 
          rad
      real (kind=dbl_kind) ::& 
          V, Const2 
          
      Const2 = 1.438786_dbl_kind
      
      V = Const2*(wv/T)
      
      if (V<1.5) then 
        rad = planck_power(T, wv)
      else
        rad = planck_exponent(T,wv)
      endif
      
      end function Rad_calculate
          
          
      
      function Planck_int(T,wvlo,wvhi,rad1,rad2) &
               result(flux) 
     
            
      real (kind=dbl_kind), intent(in)::&
         T, &
         wvlo, &
         wvhi, &
         rad1, &
         rad2
      real(kind=dbl_kind) ::&
         flux 
      real (kind=dbl_kind) ::& 
         V1,V2, Const2
         
      
      Const2 = 1.438786_dbl_kind
      
      V1 = Const2*wvlo/T
      V2 = Const2*wvhi/T
         
     if (V1<1.5 .and. V2<1.5) then
       flux = pi*((stefan_boltzmann*T**4/pi)*(rad2-rad1))
     elseif (V1<1.5 .and. V2>1.5) then 
        flux = pi*((stefan_boltzmann*T**4/pi)*(1-rad1-rad2))
     elseif (V1>1.5 .and. V2>1.5) then
        flux = pi*((stefan_boltzmann*T**4/pi)*(rad1-rad2))
     endif  
     
     end function Planck_int   
!=======================================================================
! Longwave Flux
!=======================================================================

! Added by ZSW 3/25/19
! Longwave flux along 16 bands RRTMG 
      subroutine rrtmg_longwave_flux(T, flw_bnds)     
                                     !flw1, &
                                     !flw2,   flw3, & 
                                     !flw4,   flw5, &  
                                     !flw6,   flw7, &  
                                     !flw8,   flw9, &     
                                     !flw10,  flw11,&  
                                     !flw12,  flw13,&  
                                     !flw14,  flw15,&  
                                     !flw16)
      use ice_constants_colpkg
      use ice_warnings, only: add_warning
      
      character (len=char_len_long) :: & 
         warning   
      ! input 
      real(kind=dbl_kind), intent(in) ::&
          T ! Surface temperature in Kelvin 
      
      ! output    
      real (kind=dbl_kind), dimension(lw_nbd), intent(out) :: & 
          flw_bnds
      real(kind=dbl_kind) :: &!, intent(out)::& 
          flw1,  & 
          flw2,  & 
          flw3,  & 
          flw4,  & 
          flw5,  & 
          flw6,  & 
          flw7,  & 
          flw8,  & 
          flw9,  & 
          flw10, & 
          flw11, & 
          flw12, & 
          flw13, & 
          flw14, & 
          flw15, & 
          flw16
      
      ! local 
      real (kind=dbl_kind), dimension(lw_nbd+1):: &
          rad_local
      real(kind=dbl_kind) ::&
          rad1,  & 
          rad2,  & 
          rad3,  & 
          rad4,  & 
          rad5,  & 
          rad6,  & 
          rad7,  & 
          rad8,  & 
          rad9,  & 
          rad10, & 
          rad11, & 
          rad12, & 
          rad13, & 
          rad14, & 
          rad15, & 
          rad16, &
          rad17
      integer (kind=int_kind) :: &  
          k, & !counter    
          j ! counter
         
      do k=1, lw_nbd+1 
         rad_local(k) = Rad_calculate(wvn_rrtmg(k), T)
      enddo
      
      do j=1, lw_nbd
         flw_bnds(j) = Planck_int(T, wvn_rrtmg(j), wvn_rrtmg(j+1), rad_local(j), rad_local(j+1))
      enddo
      flw_bnds(1) = flw_bnds(1)+ pi*((stefan_boltzmann*T**4/pi)*&
      planck_power(T,wvn_rrtmg(1)))
      
      flw_bnds(16) = flw_bnds(16)+(pi*((stefan_boltzmann*T**4/pi)*&
      planck_exponent(T,wvn_rrtmg(17))))
      
      rad1 = Rad_calculate(wvn1, T)
      rad2 = Rad_calculate(wvn2, T)
      rad3 = Rad_calculate(wvn3, T)
      rad4 = Rad_calculate(wvn4, T)
      rad5 = Rad_calculate(wvn5, T)
      rad6 = Rad_calculate(wvn6, T)
      rad7 = Rad_calculate(wvn7, T)
      rad8 = Rad_calculate(wvn8, T)
      rad9 = Rad_calculate(wvn9, T)
      rad10 = Rad_calculate(wvn10, T)
      rad11 = Rad_calculate(wvn11, T)
      rad12 = Rad_calculate(wvn12,T)
      rad13 = Rad_calculate(wvn13, T)
      rad14 = Rad_calculate(wvn14, T)
      rad15 = Rad_calculate(wvn15, T)
      rad16 = Rad_calculate(wvn16, T)
      rad17 = Rad_calculate(wvn17, T)
      
      flw1 = Planck_int(T,wvn1, wvn2, rad1, rad2)+(pi*((stefan_boltzmann*T**4/pi)*&
      planck_power(T,wvn1)))
      flw2 = Planck_int(T,wvn2,wvn3,rad2,rad3)
      flw3 = Planck_int(T,wvn3,wvn4,rad3,rad4)
      flw4 = Planck_int(T,wvn4,wvn5,rad4,rad5)
      flw5 = Planck_int(T,wvn5,wvn6,rad5,rad6)
      flw6 = Planck_int(T,wvn6,wvn7,rad6,rad7)
      flw7 = Planck_int(T,wvn7,wvn8,rad7,rad8)
      flw8 = Planck_int(T,wvn8,wvn9,rad8,rad9)
      flw9 = Planck_int(T,wvn9,wvn10,rad9,rad10)
      flw10 = Planck_int(T,wvn10,wvn11,rad10,rad11)
      flw11 = Planck_int(T,wvn11,wvn12,rad11,rad12)
      flw12 = Planck_int(T,wvn13,wvn13,rad12,rad13)
      flw13 = Planck_int(T,wvn13,wvn14,rad13,rad14)
      flw14 = Planck_int(T,wvn14,wvn15,rad14,rad15)
      flw15 = Planck_int(T,wvn15,wvn16,rad15,rad16)
      flw16 = Planck_int(T,wvn16,wvn17,rad16,rad17)+(pi*((stefan_boltzmann*T**4/pi)*&
      planck_exponent(T,wvn17)))
      
      !write(warning, *) 'old, new, 1', flw1, flw_bnds(1)
      !call add_warning(warning)
      
      !write(warning, *) 'old, new, 2', flw2, flw_bnds(2)
      !call add_warning(warning)
      
      !write(warning, *) 'old, new, 16', flw16, flw_bnds(16)
      !call add_warning(warning)
      
      end subroutine rrtmg_longwave_flux
      
      subroutine rrtmgp_longwave_flux(T, flw_bnds)   
                                     !flw1, &
                                     !flw2,    flw3, & 
                                     !flw4,    flw5, &  
                                     !flw6,    flw7, &  
                                     !flw8,    flw9, &     
                                     !flw10,   flw11,&  
                                     !flw12,   flw13,&  
                                     !flw14,   flw15,&  
                                     !flw16)
      use ice_constants_colpkg
      ! input 
      real(kind=dbl_kind), intent(in) ::&
          T ! Surface temperature in Kelvin 
      
      ! output    
      real (kind=dbl_kind), dimension(lw_nbd), intent(out) :: & 
          flw_bnds
      integer (kind=int_kind) :: &  
          k, & !counter    
          j ! counter
      !real(kind=dbl_kind), intent(out)::& 
      !    flw1,  & 
      !    flw2,  & 
      !    flw3,  & 
      !    flw4,  & 
      !    flw5,  & 
      !    flw6,  & 
      !    flw7,  & 
      !    flw8,  & 
      !    flw9,  & 
      !    flw10, & 
      !    flw11, & 
      !    flw12, & 
      !    flw13, & 
      !    flw14, & 
      !    flw15, & 
      !    flw16
      
      ! local 
      real (kind=dbl_kind), dimension(lw_nbd+1):: &
          rad_local      
      !real(kind=dbl_kind) ::&
      !    rad1,  & 
      !    rad2,  & 
      !    rad3,  & 
      !    rad4,  & 
      !    rad5,  & 
      !    rad6,  & 
      !    rad7,  & 
      !    rad8,  & 
      !    rad9,  & 
      !    rad10, & 
      !    rad11, & 
      !    rad12, & 
      !    rad13, & 
      !    rad14, & 
      !    rad15, & 
      !    rad16, &
      !    rad17
      do k=1, lw_nbd+1 
         rad_local(k) = Rad_calculate(wvn_rrtmgp(k), T)
      enddo
     
      do j=1, lw_nbd
         flw_bnds(j) = Planck_int(T, wvn_rrtmgp(j), wvn_rrtmgp(j+1), rad_local(j), rad_local(j+1))
      enddo
      flw_bnds(1) = flw_bnds(1)+ pi*((stefan_boltzmann*T**4/pi)*&
      planck_power(T,wvn_rrtmgp(1)))
      
      flw_bnds(16) = flw_bnds(16)+(pi*((stefan_boltzmann*T**4/pi)*&
      planck_exponent(T,wvn_rrtmgp(17))))
            
      !rad1 = Rad_calculate(wvn1, T)
      !rad2 = Rad_calculate(wvn2_gp, T)
      !rad3 = Rad_calculate(wvn3, T)
      !rad4 = Rad_calculate(wvn4, T)
      !rad5 = Rad_calculate(wvn5, T)
      !rad6 = Rad_calculate(wvn6, T)
      !rad7 = Rad_calculate(wvn7, T)
      !rad8 = Rad_calculate(wvn8, T)
      !rad9 = Rad_calculate(wvn9, T)
      !rad10 = Rad_calculate(wvn10, T)
      !rad11 = Rad_calculate(wvn11, T)
      !rad12 = Rad_calculate(wvn12,T)
      !rad13 = Rad_calculate(wvn13, T)
      !rad14 = Rad_calculate(wvn14, T)
      !rad15 = Rad_calculate(wvn15_gp, T)
      !rad16 = Rad_calculate(wvn16_gp, T)
      !rad17 = Rad_calculate(wvn17, T)
      
      !flw1 = Planck_int(T,wvn1, wvn2_gp, rad1, rad2)+(pi*((stefan_boltzmann*T**4/pi)*&
      !planck_power(T,wvn1)))
      !flw2 = Planck_int(T,wvn2_gp,wvn3,rad2,rad3)
      !flw3 = Planck_int(T,wvn3,wvn4,rad3,rad4)
      !flw4 = Planck_int(T,wvn4,wvn5,rad4,rad5)
      !flw5 = Planck_int(T,wvn5,wvn6,rad5,rad6)
      !flw6 = Planck_int(T,wvn6,wvn7,rad6,rad7)
      !flw7 = Planck_int(T,wvn7,wvn8,rad7,rad8)
      !flw8 = Planck_int(T,wvn8,wvn9,rad8,rad9)
      !flw9 = Planck_int(T,wvn9,wvn10,rad9,rad10)
      !flw10 = Planck_int(T,wvn10,wvn11,rad10,rad11)
      !flw11 = Planck_int(T,wvn11,wvn12,rad11,rad12)
      !flw12 = Planck_int(T,wvn13,wvn13,rad12,rad13)
      !flw13 = Planck_int(T,wvn13,wvn14,rad13,rad14)
      !flw14 = Planck_int(T,wvn14,wvn15,rad14,rad15)
      !flw15 = Planck_int(T,wvn15,wvn16,rad15,rad16)
      !flw16 = Planck_int(T,wvn16_gp,wvn17,rad16,rad17)+(pi*((stefan_boltzmann*T**4/pi)*&
      !planck_exponent(T,wvn17)))
      
      end subroutine rrtmgp_longwave_flux
      
      subroutine longwave_re_emitted_flux(flw1, flw2,  &
                                        flw3, flw4,  &
                                        flw5, flw6,  &
                                        flw7, flw8,  &
                                        flw9, flw10, &
                                        flw11,flw12, &
                                        flw13, flw14, &
                                        flw15, flw16, &
                                        flwdrem_ice, flwdrem_snow, &
                                        flwdrem_pond) 
      !use ice_constants_colpkg
      use ice_colpkg_shared, only: longwave
      
      real (kind=dbl_kind),intent(in) ::& 
         flw1, &
         flw2, &
         flw3, &
         flw4, &
         flw5, &
         flw6, &
         flw7, &
         flw8, &
         flw9, &
         flw10, &
         flw11, &
         flw12, &
         flw13, &
         flw14, &
         flw15, &
         flw16 
                  
      real(kind=dbl_kind), intent(out) ::& 
         flwdrem_ice, &
         flwdrem_snow, &
         flwdrem_pond
         
      real(kind=dbl_kind) ::&
         flwi_1_ice,    &  
         flwi_2_ice,    & 
         flwi_3_ice,    & 
         flwi_4_ice,    &
         flwi_5_ice,    & 
         flwi_6_ice,    & 
         flwi_7_ice,    & 
         flwi_8_ice,    & 
         flwi_9_ice,    & 
         flwi_10_ice,   &
         flwi_11_ice,   & 
         flwi_12_ice,   &
         flwi_13_ice,   & 
         flwi_14_ice,   & 
         flwi_15_ice,   & 
         flwi_16_ice,   &   
         flwi_1_snow,    & 
         flwi_2_snow,    & 
         flwi_3_snow,    & 
         flwi_4_snow,    & 
         flwi_5_snow,    & 
         flwi_6_snow,    & 
         flwi_7_snow,    & 
         flwi_8_snow,    & 
         flwi_9_snow,    & 
         flwi_10_snow,   & 
         flwi_11_snow,   & 
         flwi_12_snow,   & 
         flwi_13_snow,   & 
         flwi_14_snow,   & 
         flwi_15_snow,   & 
         flwi_16_snow,   &
         flwi_1_pond,    & 
         flwi_2_pond,    & 
         flwi_3_pond,    & 
         flwi_4_pond,    & 
         flwi_5_pond,    & 
         flwi_6_pond,    & 
         flwi_7_pond,    & 
         flwi_8_pond,    & 
         flwi_9_pond,    & 
         flwi_10_pond,   & 
         flwi_11_pond,   & 
         flwi_12_pond,   & 
         flwi_13_pond,   & 
         flwi_14_pond,   & 
         flwi_15_pond,   & 
         flwi_16_pond
                
       if (longwave== 'rrtmg') then    
          
           flwi_1_ice = (c1-emissivity_ice1)*(flw1)
           flwi_2_ice = (c1-emissivity_ice2)*(flw2)
           flwi_3_ice = (c1-emissivity_ice3)*(flw3)
           flwi_4_ice = (c1-emissivity_ice4)*(flw4)
           flwi_5_ice = (c1-emissivity_ice5)*(flw5)
           flwi_6_ice = (c1-emissivity_ice6)*(flw6)
           flwi_7_ice = (c1-emissivity_ice7)*(flw7)
           flwi_8_ice =(c1-emissivity_ice8)*(flw8)
           flwi_9_ice = (c1-emissivity_ice9)*(flw9)
           flwi_10_ice = (c1-emissivity_ice10)*(flw10)
           flwi_11_ice = (c1-emissivity_ice11)*(flw11)
           flwi_12_ice = (c1-emissivity_ice12)*(flw12)
           flwi_13_ice = (c1-emissivity_ice13)*(flw13)
           flwi_14_ice = (c1-emissivity_ice14)*(flw14)
           flwi_15_ice = (c1-emissivity_ice15)*(flw15)
           flwi_16_ice = (c1-emissivity_ice16)*(flw16)
           
           flwi_1_snow = (c1-emissivity_snow1)*(flw1)
           flwi_2_snow = (c1-emissivity_snow2)*(flw2)
           flwi_3_snow = (c1-emissivity_snow3)*(flw3)
           flwi_4_snow = (c1-emissivity_snow4)*(flw4)
           flwi_5_snow = (c1-emissivity_snow5)*(flw5)
           flwi_6_snow = (c1-emissivity_snow6)*(flw6)
           flwi_7_snow = (c1-emissivity_snow7)*(flw7)
           flwi_8_snow =(c1-emissivity_snow8)*(flw8)
           flwi_9_snow = (c1-emissivity_snow9)*(flw9)
           flwi_11_snow = (c1-emissivity_snow11)*(flw11)
           flwi_12_snow = (c1-emissivity_snow12)*(flw12)
           flwi_13_snow = (c1-emissivity_snow13)*(flw13)
           flwi_14_snow = (c1-emissivity_snow14)*(flw14)
           flwi_15_snow = (c1-emissivity_snow15)*(flw15)
           flwi_16_snow = (c1-emissivity_snow16)*(flw16)
           
           flwi_1_pond = (c1-emissivity_pond1)*(flw1)
           flwi_2_pond = (c1-emissivity_pond2)*(flw2)
           flwi_3_pond = (c1-emissivity_pond3)*(flw3)
           flwi_4_pond = (c1-emissivity_pond4)*(flw4)
           flwi_5_pond = (c1-emissivity_pond5)*(flw5)
           flwi_6_pond = (c1-emissivity_pond6)*(flw6)
           flwi_7_pond = (c1-emissivity_pond7)*(flw7)
           flwi_8_pond =(c1-emissivity_pond8)*(flw8)
           flwi_9_pond = (c1-emissivity_pond9)*(flw9)
           flwi_10_pond = (c1-emissivity_pond10)*(flw10)
           flwi_11_pond = (c1-emissivity_pond11)*(flw11)
           flwi_12_pond = (c1-emissivity_pond12)*(flw12)
           flwi_13_pond = (c1-emissivity_pond13)*(flw13)
           flwi_14_pond = (c1-emissivity_pond14)*(flw14)
           flwi_15_pond = (c1-emissivity_pond15)*(flw15)
           flwi_16_pond = (c1-emissivity_pond16)*(flw16)
           
           flwdrem_ice = flwi_1_ice+flwi_2_ice+flwi_3_ice+flwi_4_ice+&
           flwi_5_ice+flwi_6_ice+flwi_7_ice+flwi_8_ice+flwi_9_ice+&
           flwi_10_ice+flwi_11_ice+flwi_12_ice+flwi_13_ice+flwi_14_ice+&
           flwi_15_ice+flwi_16_ice
           
           flwdrem_snow = flwi_1_snow+flwi_2_snow+flwi_3_snow+flwi_4_snow+&
           flwi_5_snow+flwi_6_snow+flwi_7_snow+flwi_8_snow+flwi_9_snow+&
           flwi_10_snow+flwi_11_snow+flwi_12_snow+flwi_13_snow+flwi_14_snow+&
           flwi_15_snow+flwi_16_snow   
           
           flwdrem_pond = flwi_1_pond+flwi_2_pond+flwi_3_pond+flwi_4_pond+&
           flwi_5_pond+flwi_6_pond+flwi_7_pond+flwi_8_pond+flwi_9_pond+&
           flwi_10_pond+flwi_11_pond+flwi_12_pond+flwi_13_pond+flwi_14_pond+&
           flwi_15_pond+flwi_16_pond   
       else 
           flwi_1_ice = (c1-emissivity_ice1_gp)*(flw1)
           flwi_2_ice = (c1-emissivity_ice2_gp)*(flw2)
           flwi_3_ice = (c1-emissivity_ice3)*(flw3)
           flwi_4_ice = (c1-emissivity_ice4)*(flw4)
           flwi_5_ice = (c1-emissivity_ice5)*(flw5)
           flwi_6_ice = (c1-emissivity_ice6)*(flw6)
           flwi_7_ice = (c1-emissivity_ice7)*(flw7)
           flwi_8_ice =(c1-emissivity_ice8)*(flw8)
           flwi_9_ice = (c1-emissivity_ice9)*(flw9)
           flwi_10_ice = (c1-emissivity_ice10)*(flw10)
           flwi_11_ice = (c1-emissivity_ice11)*(flw11)
           flwi_12_ice = (c1-emissivity_ice12)*(flw12)
           flwi_13_ice = (c1-emissivity_ice13)*(flw13)
           flwi_14_ice = (c1-emissivity_ice14)*(flw14)
           flwi_15_ice = (c1-emissivity_ice15_gp)*(flw15)
           flwi_16_ice = (c1-emissivity_ice16)*(flw16)
           
           flwi_1_snow = (c1-emissivity_snow1_gp)*(flw1)
           flwi_2_snow = (c1-emissivity_snow2)*(flw2)
           flwi_3_snow = (c1-emissivity_snow3)*(flw3)
           flwi_4_snow = (c1-emissivity_snow4)*(flw4)
           flwi_5_snow = (c1-emissivity_snow5)*(flw5)
           flwi_6_snow = (c1-emissivity_snow6)*(flw6)
           flwi_7_snow = (c1-emissivity_snow7)*(flw7)
           flwi_8_snow =(c1-emissivity_snow8)*(flw8)
           flwi_9_snow = (c1-emissivity_snow9)*(flw9)
           flwi_10_snow = (c1-emissivity_snow10)*(flw10)
           flwi_11_snow = (c1-emissivity_snow11)*(flw11)
           flwi_12_snow = (c1-emissivity_snow12)*(flw12)
           flwi_13_snow = (c1-emissivity_snow13)*(flw13)
           flwi_14_snow = (c1-emissivity_snow14)*(flw14)
           flwi_15_snow = (c1-emissivity_snow15)*(flw15)
           flwi_16_snow = (c1-emissivity_snow16_gp)*(flw16)
           
           flwi_1_pond = (c1-emissivity_pond1_gp)*(flw1)
           flwi_2_pond = (c1-emissivity_pond2)*(flw2)
           flwi_3_pond = (c1-emissivity_pond3)*(flw3)
           flwi_4_pond = (c1-emissivity_pond4)*(flw4)
           flwi_5_pond = (c1-emissivity_pond5)*(flw5)
           flwi_6_pond = (c1-emissivity_pond6)*(flw6)
           flwi_7_pond = (c1-emissivity_pond7)*(flw7)
           flwi_8_pond =(c1-emissivity_pond8)*(flw8)
           flwi_9_pond = (c1-emissivity_pond9)*(flw9)
           flwi_10_pond = (c1-emissivity_pond10)*(flw10)
           flwi_11_pond = (c1-emissivity_pond11)*(flw11)
           flwi_12_pond = (c1-emissivity_pond12)*(flw12)
           flwi_13_pond = (c1-emissivity_pond13)*(flw13)
           flwi_14_pond = (c1-emissivity_pond14)*(flw14)
           flwi_15_pond = (c1-emissivity_pond15)*(flw15)
           flwi_16_pond = (c1-emissivity_pond16_gp)*(flw16)
           
           flwdrem_ice = flwi_1_ice+flwi_2_ice+flwi_3_ice+flwi_4_ice+&
           flwi_5_ice+flwi_6_ice+flwi_7_ice+flwi_8_ice+flwi_9_ice+&
           flwi_10_ice+flwi_11_ice+flwi_12_ice+flwi_13_ice+flwi_14_ice+&
           flwi_15_ice+flwi_16_ice
           
           flwdrem_snow = flwi_1_snow+flwi_2_snow+flwi_3_snow+flwi_4_snow+&
           flwi_5_snow+flwi_6_snow+flwi_7_snow+flwi_8_snow+flwi_9_snow+&
           flwi_10_snow+flwi_11_snow+flwi_12_snow+flwi_13_snow+flwi_14_snow+&
           flwi_15_snow+flwi_16_snow  
           
           flwdrem_pond = flwi_1_pond+flwi_2_pond+flwi_3_pond+flwi_4_pond+&
           flwi_5_pond+flwi_6_pond+flwi_7_pond+flwi_8_pond+flwi_9_pond+&
           flwi_10_pond+flwi_11_pond+flwi_12_pond+flwi_13_pond+flwi_14_pond+&
           flwi_15_pond+flwi_16_pond   
        
        endif 
        
       end subroutine longwave_re_emitted_flux      
              
       subroutine longwave_absorbed_reemit_flux(flw_bnds, &
                                                flw_ice_abs_bnds, &
                                                flw_snow_abs_bnds, &
                                                flw_ice_rem_bnds, &
                                                flw_snow_rem_bnds, &
                                                flw_pond_rem_bnds)
        
        use ice_constants_colpkg
        use ice_colpkg_shared, only: longwave    
                                               
        real(kind=dbl_kind), dimension(lw_nbd), intent(in):: & 
          flw_bnds
          
        real(kind=dbl_kind), dimension(lw_nbd), intent(out):: & 
          flw_ice_abs_bnds,  & 
          flw_snow_abs_bnds, & 
          !flw_pond_abs_bnds, &
          flw_ice_rem_bnds,  & 
          flw_snow_rem_bnds, & 
          flw_pond_rem_bnds
          
      integer (kind=int_kind) :: &  
          k !counter
          
      if (longwave == 'rrtmg') then 
         do k=1,lw_nbd
            flw_ice_abs_bnds(k) = ice_emissivity_rrtmg(k)*flw_bnds(k)
            flw_snow_abs_bnds(k) = snow_emissivity_rrtmg(k)*flw_bnds(k) 
            !flw_pond_abs_bnds(k) = pond_emissivity_rrtmg(k)*flw_bnds(k)
            
            flw_ice_rem_bnds(k) = (c1-ice_emissivity_rrtmg(k))*flw_bnds(k)
            flw_snow_rem_bnds(k) = (c1-snow_emissivity_rrtmg(k))*flw_bnds(k) 
            flw_pond_rem_bnds(k) = (c1-pond_emissivity_rrtmg(k))*flw_bnds(k)
         enddo 
       else 
         do k=1,lw_nbd
            flw_ice_abs_bnds(k) = ice_emissivity_rrtmgp(k)*flw_bnds(k)
            flw_snow_abs_bnds(k) = snow_emissivity_rrtmgp(k)*flw_bnds(k) 
            !flw_pond_abs_bnds(k) = pond_emissivity_rrtmgp(k)*flw_bnds(k)
            
            flw_ice_rem_bnds(k) = (c1-ice_emissivity_rrtmgp(k))*flw_bnds(k)
            flw_snow_rem_bnds(k) = (c1-snow_emissivity_rrtmgp(k))*flw_bnds(k) 
            flw_pond_rem_bnds(k) = (c1-pond_emissivity_rrtmgp(k))*flw_bnds(k)             
         enddo   
       endif
      end subroutine longwave_absorbed_reemit_flux
      
      subroutine longwave_emitted(flwoutn_bnds,&
                                  sfc_type, &
                                  flwoutn_sfc_type_bnds)
       
       use ice_constants_colpkg
       use ice_colpkg_shared, only: longwave 
       
       real(kind=dbl_kind), dimension(lw_nbd), intent(in):: & 
          flwoutn_bnds 
       character(len=*), intent(in):: & 
          sfc_type
       real(kind=dbl_kind), dimension(lw_nbd), intent(out):: & 
          flwoutn_sfc_type_bnds
          
      integer (kind=int_kind) :: &  
          k !counter
          
      if (longwave == 'rrtmg') then 
         do k=1, lw_nbd
            if (sfc_type == 'snow') then 
                flwoutn_sfc_type_bnds(k) = -snow_emissivity_rrtmg(k)*flwoutn_bnds(k) 
            else if (sfc_type == 'pond') then 
                flwoutn_sfc_type_bnds(k) = -pond_emissivity_rrtmg(k)*flwoutn_bnds(k)
            else if (sfc_type == 'ice') then
                flwoutn_sfc_type_bnds(k) = -ice_emissivity_rrtmg(k)*flwoutn_bnds(k)
            endif !sfc_type
        enddo 
      else 
         do k=1,lw_nbd
            if (sfc_type == 'snow') then 
                flwoutn_sfc_type_bnds(k) = -snow_emissivity_rrtmgp(k)*flwoutn_bnds(k) 
            else if (sfc_type == 'pond') then 
                flwoutn_sfc_type_bnds(k) = -pond_emissivity_rrtmgp(k)*flwoutn_bnds(k)
            else if (sfc_type == 'ice') then
                flwoutn_sfc_type_bnds(k) = -ice_emissivity_rrtmgp(k)*flwoutn_bnds(k)
            endif !sfc_type          
         enddo   
       endif !longwave
      end subroutine longwave_emitted                                    
!=======================================================================
! Surface heat flux
!=======================================================================
! heat flux into ice
    
      subroutine surface_heat_flux(Tsf,     fswsfc, &
                                   rhoa,    flw,    &                                   
                                   potT,    Qa,     &
                                   shcoef,  lhcoef, &
                                   flwoutn,         &  
                                   fsensn, &
                                   flatn,   fsurfn, &
                                   l_snow, & 
                                   flw_ice_abs_bnds,&
                                   flw_snow_abs_bnds, &
                                   flwoutn_bnds, &
                                   flwoutn_bnds_sfc_type)
                                   !flw1,    flw2,   & 
                                   !flw3,    flw4,   & 
                                   !flw5,    flw6,   & 
                                   !flw7,    flw8,   & 
                                   !flw9,    flw10,  & 
                                   !flw11,   flw12,  & 
                                   !flw13,   flw14,  & 
                                   !flw15,   flw16,  & 
                                   !flwoutn1, flwoutn2,& 
                                   !flwoutn3, flwoutn4,& 
                                   !flwoutn5, flwoutn6,& 
                                   !flwoutn7, flwoutn8,& 
                                   !flwoutn9, flwoutn10,& 
                                   !flwoutn11, flwoutn12,& 
                                   !flwoutn13, flwoutn14,& 
                                   !flwoutn15, flwoutn16, &
                                   

      use ice_constants_colpkg
      use ice_colpkg_shared, only: longwave
      use ice_warnings, only: add_warning
      ! input surface temperature
      real(kind=dbl_kind), intent(in) :: &
         Tsf             ! ice/snow surface temperature (C)
    
      ! input variables
      real(kind=dbl_kind), intent(in) :: &
         fswsfc      , & ! SW absorbed at ice/snow surface (W m-2)
         rhoa        , & ! air density (kg/m^3)
         flw         , & ! incoming longwave radiation (W/m^2)       
         potT        , & ! air potential temperature  (K)
         Qa          , & ! specific humidity (kg/kg)
         shcoef      , & ! transfer coefficient for sensible heat
         lhcoef          ! transfer coefficient for latent heat
      real(kind=dbl_kind),dimension(lw_nbd), intent(in), optional:: &   
         flw_ice_abs_bnds, &
         flw_snow_abs_bnds
      !real(kind=dbl_kind), intent(in), optional :: &
      !   flw1        , & ! incoming longwave radiation band 1 (W/m^2)
      !   flw2        , & ! incoming longwave radiation band 2 (W/m^2)
      !   flw3        , & ! incoming longwave radiation band 3 (W/m^2)
      !   flw4        , & ! incoming longwave radiation band 4 (W/m^2)
      !   flw5        , & ! incoming longwave radiation band 5 (W/m^2)
      !   flw6        , & ! incoming longwave radiation band 6 (W/m^2)
      !   flw7        , & ! incoming longwave radiation band 7 (W/m^2)
      !   flw8        , & ! incoming longwave radiation band 8 (W/m^2)
      !   flw9        , & ! incoming longwave radiation band 9 (W/m^2)
      !   flw10       , & ! incoming longwave radiation band 10 (W/m^2)
      !   flw11       , & ! incoming longwave radiation band 11 (W/m^2)
      !   flw12       , & ! incoming longwave radiation band 12 (W/m^2)
      !   flw13       , & ! incoming longwave radiation band 13 (W/m^2)
      !   flw14       , & ! incoming longwave radiation band 14 (W/m^2)
      !   flw15       , & ! incoming longwave radiation band 15 (W/m^2)
      !   flw16        ! incoming longwave radiation band 16 (W/m^2)
       logical (kind=log_kind), intent(in), optional :: &
         l_snow ! snow true or false
    
      ! output
      real(kind=dbl_kind), intent(out) :: &
         fsensn      , & ! surface downward sensible heat (W m-2)
         flatn       , & ! surface downward latent heat (W m-2)
         flwoutn     , & ! upward LW at surface (W m-2)
         fsurfn          ! net flux to top surface, excluding fcondtopn 
      !real(kind=dbl_kind), intent(out), optional :: &
         !flwoutn1,     & ! upward LW at surface band 1 (W m-2)
         !flwoutn2,     & ! upward LW at surface band 2 (W m-2)
         !flwoutn3,     & ! upward LW at surface band 3 (W m-2)
         !flwoutn4,     & ! upward LW at surface band 4 (W m-2)
         !flwoutn5,     & ! upward LW at surface band 5 (W m-2)
         !flwoutn6,     & ! upward LW at surface band 6 (W m-2)
         !flwoutn7,     & ! upward LW at surface band 7 (W m-2)
         !flwoutn8,     & ! upward LW at surface band 8 (W m-2)
         !flwoutn9,     & ! upward LW at surface band 9 (W m-2)
         !flwoutn10,    & ! upward LW at surface band 10 (W m-2)
         !flwoutn11,    & ! upward LW at surface band 11 (W m-2)
         !flwoutn12,    & ! upward LW at surface band 12 (W m-2)
         !flwoutn13,    & ! upward LW at surface band 13 (W m-2)
         !flwoutn14,    & ! upward LW at surface band 14 (W m-2)
         !flwoutn15,    & ! upward LW at surface band 15 (W m-2)
         !flwoutn16       ! upward LW at surface band 16 (W m-2)
      real (kind=dbl_kind), intent(out), dimension(lw_nbd), optional :: & 
         flwoutn_bnds, & !upward LW at surface banded no emissivity
         flwoutn_bnds_sfc_type !!upward LW at surface banded with sfc. emissivity
      ! local variables
      real(kind=dbl_kind) :: &
         TsfK        , & ! ice/snow surface temperature (K)
         Qsfc        , & ! saturated surface specific humidity (kg/kg)
         qsat        , & ! the saturation humidity of air (kg/m^3)
         flwdabs     , & ! downward longwave absorbed heat flx (W/m^2)
         tmpvar          ! 1/TsfK
    
    
      !real(kind=dbl_kind) ::&
      !   flwi_1,    & ! absorbed LW band 1
      !   flwi_2,    & ! absorbed LW band 1
      !   flwi_3,    & ! absorbed LW band 1
      !   flwi_4,    & ! absorbed LW band 1
      !   flwi_5,    & ! absorbed LW band 1
      !   flwi_6,    & ! absorbed LW band 1
      !   flwi_7,    & ! absorbed LW band 1
      !   flwi_8,    & ! absorbed LW band 1
      !   flwi_9,    & ! absorbed LW band 1
      !   flwi_10,   & ! absorbed LW band 1
      !   flwi_11,   & ! absorbed LW band 1
      !   flwi_12,   & ! absorbed LW band 1
      !   flwi_13,   & ! absorbed LW band 1
      !   flwi_14,   & ! absorbed LW band 1
      !   flwi_15,   & ! absorbed LW band 1
      !   flwi_16      ! absorbed LW band 1
      
      real (kind=dbl_kind) :: &
         flwoutn_old, &
         flwdabs_old
         
      character (len=char_len_long) :: & 
         warning   
      
      logical (kind= log_kind) :: &
         l_stop   
      ! ice surface temperature in Kelvin
      TsfK = Tsf + Tffresh
!      TsfK = max(Tsf + Tffresh, c1)
      tmpvar = c1/TsfK
      
    ! saturation humidity
      qsat    = qqqice * exp(-TTTice*tmpvar)
      Qsfc    = qsat / rhoa
          
          ! longwave radiative flux
      if (longwave =='rrtmg') then
          ! RRTMG Bands 
          call rrtmg_longwave_flux(TsfK, flwoutn_bnds)
          
          !flwoutn1,flwoutn2, &
           !                       flwoutn3, flwoutn4, flwoutn5, &
           !                        flwoutn6, flwoutn7, flwoutn8, &
           !                        flwoutn9, flwoutn10,flwoutn11, &
           !                        flwoutn12, flwoutn13, flwoutn14, &
           !                        flwoutn15, flwoutn16)
           
           !flwoutn_bnds = (/ flwoutn1, flwoutn2, flwoutn3, flwoutn4, &
           !                  flwoutn5, flwoutn6, flwoutn7, flwoutn8, & 
           !                  flwoutn9, flwoutn10, flwoutn11,flwoutn12, &
           !                  flwoutn13, flwoutn14, flwoutn15, flwoutn16 /)
           
           if (l_snow) then
              call longwave_emitted(flwoutn_bnds, 'snow', flwoutn_bnds_sfc_type)
              flwdabs = SUM(flw_snow_abs_bnds)
              !flwi_1 = emissivity_snow1*(flw1)
              !flwi_2 = emissivity_snow2*(flw2)
              !flwi_3 = emissivity_snow3*(flw3)
              !flwi_4 = emissivity_snow4*(flw4)
              !flwi_5 = emissivity_snow5*(flw5)
              !flwi_6 = emissivity_snow6*(flw6)
              !flwi_7 = emissivity_snow7*(flw7)
              !flwi_8 = emissivity_snow8*(flw8)
              !flwi_9 = emissivity_snow9*(flw9)
              !flwi_10= emissivity_snow10*(flw10)
              !flwi_11= emissivity_snow11*(flw11)
              !flwi_12= emissivity_snow12*(flw12)
              !flwi_13= emissivity_snow13*(flw13)
              !flwi_14= emissivity_snow14*(flw14)
              !flwi_15= emissivity_snow15*(flw15)
              !flwi_16= emissivity_snow16*(flw16)
               
              !flwoutn1 = -emissivity_snow1*(flwoutn1)
              !flwoutn2 = -emissivity_snow2*(flwoutn2)
              !flwoutn3 = -emissivity_snow3*(flwoutn3)
              !flwoutn4 = -emissivity_snow4*(flwoutn4)
              !flwoutn5 = -emissivity_snow5*(flwoutn5)
              !flwoutn6 = -emissivity_snow6*(flwoutn6)
              !flwoutn7 = -emissivity_snow7*(flwoutn7)
              !flwoutn8 = -emissivity_snow8*(flwoutn8)
              !flwoutn9 = -emissivity_snow9*(flwoutn9)
              !flwoutn10= -emissivity_snow10*(flwoutn10)
              !flwoutn11= -emissivity_snow11*(flwoutn11)
              !flwoutn12= -emissivity_snow12*(flwoutn12)
              !flwoutn13= -emissivity_snow13*(flwoutn13)
              !flwoutn14= -emissivity_snow14*(flwoutn14)
              !flwoutn15= -emissivity_snow15*(flwoutn15)
              !flwoutn16= -emissivity_snow16*(flwoutn16)
              
          else
              call longwave_emitted(flwoutn_bnds, 'ice', flwoutn_bnds_sfc_type)
              flwdabs = SUM(flw_ice_abs_bnds)
              !flwi_1 = emissivity_ice1*(flw1)
              !flwi_2 = emissivity_ice2*(flw2)
              !flwi_3 = emissivity_ice3*(flw3)
              !flwi_4 = emissivity_ice4*(flw4)
              !flwi_5 = emissivity_ice5*(flw5)
              !flwi_6 = emissivity_ice6*(flw6)
              !flwi_7 = emissivity_ice7*(flw7)
              !flwi_8 = emissivity_ice8*(flw8)
              !flwi_9 = emissivity_ice9*(flw9)
              !flwi_10= emissivity_ice10*(flw10)
              !flwi_11= emissivity_ice11*(flw11)
              !flwi_12= emissivity_ice12*(flw12)
              !flwi_13= emissivity_ice13*(flw13)
              !flwi_14= emissivity_ice14*(flw14)
              !flwi_15= emissivity_ice15*(flw15)
              !flwi_16= emissivity_ice16*(flw16)
                              
              
              !flwoutn1 = -emissivity_ice1*(flwoutn1)
              !flwoutn2 = -emissivity_ice2*(flwoutn2)
              !flwoutn3 = -emissivity_ice3*(flwoutn3)
              !flwoutn4 = -emissivity_ice4*(flwoutn4)
              !flwoutn5 = -emissivity_ice5*(flwoutn5)
              !flwoutn6 = -emissivity_ice6*(flwoutn6)
              !flwoutn7 = -emissivity_ice7*(flwoutn7)
              !flwoutn8 = -emissivity_ice8*(flwoutn8)
              !flwoutn9 = -emissivity_ice9*(flwoutn9)
              !flwoutn10= -emissivity_ice10*(flwoutn10)
              !flwoutn11= -emissivity_ice11*(flwoutn11)
              !flwoutn12= -emissivity_ice12*(flwoutn12)
              !flwoutn13= -emissivity_ice13*(flwoutn13)
              !flwoutn14= -emissivity_ice14*(flwoutn14)
              !flwoutn15= -emissivity_ice15*(flwoutn15)
              !flwoutn16= -emissivity_ice16*(flwoutn16)
          endif
          !flwdabs = flwi_1+flwi_2+flwi_3+flwi_4+flwi_5+flwi_6+ &
          !flwi_7+flwi_8+flwi_9+flwi_10+flwi_11+flwi_12+&
          !flwi_13+flwi_14+flwi_15+flwi_16 
          
          !flwoutn = flwoutn1+flwoutn2+flwoutn3+flwoutn4+flwoutn5+flwoutn6+flwoutn7+ &
          !flwoutn8+flwoutn9+flwoutn10+flwoutn11+flwoutn12+flwoutn13+flwoutn14+ &
          !flwoutn15+flwoutn16    
         
          flwoutn = SUM(flwoutn_bnds_sfc_type)
      else if (longwave == 'rrtmgp') then 
      
          ! RRTMGP Bands 
          call rrtmgp_longwave_flux(TsfK, flwoutn_bnds)
          !call rrtmgp_longwave_flux(TsfK, flwoutn1,flwoutn2, &
          !                        flwoutn3, flwoutn4, flwoutn5, &
          !                         flwoutn6, flwoutn7, flwoutn8, &
          !                         flwoutn9, flwoutn10,flwoutn11, &
          !                         flwoutn12, flwoutn13, flwoutn14, &
          !                         flwoutn15, flwoutn16)                         

          !flwdabs =  emissivity * flw
          !flwoutn_bnds = (/ flwoutn1, flwoutn2, flwoutn3, flwoutn4, &
          !                   flwoutn5, flwoutn6, flwoutn7, flwoutn8, & 
          !                   flwoutn9, flwoutn10, flwoutn11,flwoutn12, &
          !                   flwoutn13, flwoutn14, flwoutn15, flwoutn16 /)
          if (l_snow) then
              call longwave_emitted(flwoutn_bnds, 'snow', flwoutn_bnds_sfc_type)
              flwdabs = SUM(flw_snow_abs_bnds)
              !flwi_1 = emissivity_snow1_gp*(flw1)
              !flwi_2 = emissivity_snow2_gp*(flw2)
              !flwi_3 = emissivity_snow3*(flw3)
              !flwi_4 = emissivity_snow4*(flw4)
              !flwi_5 = emissivity_snow5*(flw5)
              !flwi_6 = emissivity_snow6*(flw6)
              !flwi_7 = emissivity_snow7*(flw7)
              !flwi_8 = emissivity_snow8*(flw8)
              !flwi_9 = emissivity_snow9*(flw9)
              !flwi_10= emissivity_snow10*(flw10)
              !flwi_11= emissivity_snow11*(flw11)
              !flwi_12= emissivity_snow12*(flw12)
              !flwi_13= emissivity_snow13*(flw13)
              !flwi_14= emissivity_snow14*(flw14)
              !flwi_15= emissivity_snow15_gp*(flw15)
              !flwi_16= emissivity_snow16_gp*(flw16)
               
              !flwoutn1 = -emissivity_snow1_gp*(flwoutn1)
              !flwoutn2 = -emissivity_snow2_gp*(flwoutn2)
              !flwoutn3 = -emissivity_snow3*(flwoutn3)
              !flwoutn4 = -emissivity_snow4*(flwoutn4)
              !flwoutn5 = -emissivity_snow5*(flwoutn5)
              !flwoutn6 = -emissivity_snow6*(flwoutn6)
              !flwoutn7 = -emissivity_snow7*(flwoutn7)
              !flwoutn8 = -emissivity_snow8*(flwoutn8)
              !flwoutn9 = -emissivity_snow9*(flwoutn9)
              !flwoutn10= -emissivity_snow10*(flwoutn10)
              !flwoutn11= -emissivity_snow11*(flwoutn11)
              !flwoutn12= -emissivity_snow12*(flwoutn12)
              !flwoutn13= -emissivity_snow13*(flwoutn13)
              !flwoutn14= -emissivity_snow14*(flwoutn14)
              !flwoutn15= -emissivity_snow15*(flwoutn15)
              !flwoutn16= -emissivity_snow16_gp*(flwoutn16)
          else
              call longwave_emitted(flwoutn_bnds, 'ice', flwoutn_bnds_sfc_type)
              flwdabs = SUM(flw_ice_abs_bnds)
              !flwi_1 = emissivity_ice1_gp*(flw1)
              !flwi_2 = emissivity_ice2_gp*(flw2)
              !flwi_3 = emissivity_ice3*(flw3)
              !flwi_4 = emissivity_ice4*(flw4)
              !flwi_5 = emissivity_ice5*(flw5)
              !flwi_6 = emissivity_ice6*(flw6)
              !flwi_7 = emissivity_ice7*(flw7)
              !flwi_8 = emissivity_ice8*(flw8)
              !flwi_9 = emissivity_ice9*(flw9)
              !flwi_10= emissivity_ice10*(flw10)
              !flwi_11= emissivity_ice11*(flw11)
              !flwi_12= emissivity_ice12*(flw12)
              !flwi_13= emissivity_ice13*(flw13)
              !flwi_14= emissivity_ice14*(flw14)
              !flwi_15= emissivity_ice15_gp*(flw15)
              !flwi_16= emissivity_ice16_gp*(flw16)
                              
              
              !flwoutn1 = -emissivity_ice1_gp*(flwoutn1)
              !flwoutn2 = -emissivity_ice2_gp*(flwoutn2)
              !flwoutn3 = -emissivity_ice3*(flwoutn3)
              !flwoutn4 = -emissivity_ice4*(flwoutn4)
              !flwoutn5 = -emissivity_ice5*(flwoutn5)
              !flwoutn6 = -emissivity_ice6*(flwoutn6)
              !flwoutn7 = -emissivity_ice7*(flwoutn7)
              !flwoutn8 = -emissivity_ice8*(flwoutn8)
              !flwoutn9 = -emissivity_ice9*(flwoutn9)
              !flwoutn10= -emissivity_ice10*(flwoutn10)
              !flwoutn11= -emissivity_ice11*(flwoutn11)
              !flwoutn12= -emissivity_ice12*(flwoutn12)
              !flwoutn13= -emissivity_ice13*(flwoutn13)
              !flwoutn14= -emissivity_ice14*(flwoutn14)
              !flwoutn15= -emissivity_ice15_gp*(flwoutn15)
              !flwoutn16= -emissivity_ice16_gp*(flwoutn16)
          endif
          flwoutn = SUM(flwoutn_bnds_sfc_type)
          !flwdabs = flwi_1+flwi_2+flwi_3+flwi_4+flwi_5+flwi_6+ &
          !flwi_7+flwi_8+flwi_9+flwi_10+flwi_11+flwi_12+&
          !flwi_13+flwi_14+flwi_15+flwi_16  
          
          !flwoutn = flwoutn1+flwoutn2+flwoutn3+flwoutn4+flwoutn5+flwoutn6+flwoutn7+ &
          !flwoutn8+flwoutn9+flwoutn10+flwoutn11+flwoutn12+flwoutn13+flwoutn14+ &
          !flwoutn15+flwoutn16  
      else 
        flwdabs =  emissivity*flw
        flwoutn = -emissivity*stefan_boltzmann*Tsfk**4
      endif
      
        
      flwdabs_old =  emissivity*flw
      flwoutn_old = -emissivity*stefan_boltzmann*TsfK**4
      l_stop = flwoutn-flwoutn_old > 1e-2_dbl_kind .or. flwoutn- flwoutn_old < -1e-2_dbl_kind
      !if (l_stop) then
      !   write(warning, *) 'Thermo Error: Outgoing disagreement', flwoutn- flwoutn_old, TsfK
      !   call add_warning(warning)
         !return 
      !endif
      !l_stop = flwdabs-flwdabs_old > 1e-2_dbl_kind .or. flwdabs-flwdabs_old < -1e-2_dbl_kind
      !if (l_stop) then
      !   write(warning, *) 'Thermo Error: Incoming disagreement abs', flwdabs-flwdabs_old 
      !   call add_warning(warning)
      !   !return 
      !endif
          
      ! downward latent and sensible heat fluxes
      fsensn = shcoef * (potT - TsfK)
      flatn  = lhcoef * (Qa - Qsfc)
    
      ! combine fluxes
      fsurfn = fswsfc + flwdabs + flwoutn + fsensn + flatn

      end subroutine surface_heat_flux

  !=======================================================================
  
      subroutine dsurface_heat_flux_dTsf(Tsf,     fswsfc, &
                                         rhoa,    flw,    &
                                         potT,    Qa,     &
                                         shcoef,  lhcoef, &
                                         flwoutn,     &
                                         dfsurfn_dTsf, dflwoutn_dTsf, &
                                         dfsensn_dTsf, dflatn_dTsf, & 
                                         l_snow, &
                                         flwoutn_bnds)
                                         !flwoutn1, &
                                         !flwoutn2, flwoutn3, &
                                         !flwoutn4, flwoutn5, &
                                         !flwoutn6, flwoutn7, &
                                         !flwoutn8, flwoutn9, &
                                         !flwoutn10, flwoutn11, &
                                         !flwoutn12, flwoutn13, &
                                         !flwoutn14, flwoutn15, &
                                         !flwoutn16)
      use ice_constants_colpkg
      use ice_colpkg_shared, only: longwave
      use ice_warnings, only: add_warning
      ! input surface temperature
      real(kind=dbl_kind), intent(in) :: &
         Tsf               ! ice/snow surface temperature (C)
    
      ! input variables
      real(kind=dbl_kind), intent(in) :: &
         fswsfc        , & ! SW absorbed at ice/snow surface (W m-2)
         rhoa          , & ! air density (kg/m^3)
         flw           , & ! incoming longwave radiation (W/m^2)
         flwoutn       , & ! upward LW at surface (W m-2)
         potT          , & ! air potential temperature  (K)
         Qa            , & ! specific humidity (kg/kg)
         shcoef        , & ! transfer coefficient for sensible heat
         lhcoef            ! transfer coefficient for latent heat
       real (kind=dbl_kind), intent(in), dimension(lw_nbd), optional :: &
          flwoutn_bnds
      !real(kind=dbl_kind), intent(in), optional :: &   
      !   flwoutn1,     & ! upward LW at surface band 1 (W m-2)
      !   flwoutn2,     & ! upward LW at surface band 2 (W m-2)
      !   flwoutn3,     & ! upward LW at surface band 3 (W m-2)
      !   flwoutn4,     & ! upward LW at surface band 4 (W m-2)
      !   flwoutn5,     & ! upward LW at surface band 5 (W m-2)
      !   flwoutn6,     & ! upward LW at surface band 6 (W m-2)
      !   flwoutn7,     & ! upward LW at surface band 7 (W m-2)
      !   flwoutn8,     & ! upward LW at surface band 8 (W m-2)
      !   flwoutn9,     & ! upward LW at surface band 9 (W m-2)
      !   flwoutn10,    & ! upward LW at surface band 10 (W m-2)
      !   flwoutn11,    & ! upward LW at surface band 11 (W m-2)
      !   flwoutn12,    & ! upward LW at surface band 12 (W m-2)
      !   flwoutn13,    & ! upward LW at surface band 13 (W m-2)
      !   flwoutn14,    & ! upward LW at surface band 14 (W m-2)
      !   flwoutn15,    & ! upward LW at surface band 15 (W m-2)
      !   flwoutn16       ! upward LW at surface band 16 (W m-2)
      ! output
      real(kind=dbl_kind), intent(out) :: &
         dfsurfn_dTsf      ! derivative of net flux to top surface, excluding fcondtopn
    
      real(kind=dbl_kind), intent(out) :: &
         dflwoutn_dTsf , & ! derivative of longwave flux wrt surface temperature
         dfsensn_dTsf  , & ! derivative of sensible heat flux wrt surface temperature
         dflatn_dTsf       ! derivative of latent heat flux wrt surface temperature
    
      ! local variables
      real(kind=dbl_kind) :: &
         TsfK          , & ! ice/snow surface temperature (K)
         dQsfc_dTsf    , & ! saturated surface specific humidity (kg/kg)
         qsat          , & ! the saturation humidity of air (kg/m^3)
         tmpvar        , & ! 1/TsfK
         !flw_weight1   , &
         !flw_weight2   , &
         !flw_weight3   , &
         !flw_weight4   , &
         !flw_weight5   , &
         !flw_weight6   , &
         !flw_weight7   , &
         !flw_weight8   , &
         !flw_weight9   , &
         !flw_weight10   , &
         !flw_weight11   , &
         !flw_weight12   , &
         !flw_weight13   , &
         !flw_weight14   , &
         !flw_weight15   , &
         !flw_weight16   , &
         emiss_weight   , &
         dflwoutn_dTsf_old
     
     real(kind=dbl_kind), dimension(lw_nbd) :: & 
         flw_weight_bnds     
     real(kind=int_kind) :: &
         k !counter
     logical (kind=log_kind), intent(in), optional :: &
         l_snow ! snow true or false
     
      character (len=char_len_long) :: & 
         warning   
         
      logical (kind= log_kind) :: &
         l_stop   
      ! ice surface temperature in Kelvin
!      TsfK = max(Tsf + Tffresh, c1)
      TsfK = Tsf + Tffresh
      tmpvar = c1/TsfK
    
      ! saturation humidity
      qsat          = qqqice * exp(-TTTice*tmpvar)
      dQsfc_dTsf    = TTTice * tmpvar * tmpvar * (qsat / rhoa)
    
      ! longwave radiative flux
      
      if (longwave == 'rrtmg') then 
          if (l_snow) then
              do k=1, lw_nbd
                 flw_weight_bnds(k) = -snow_emissivity_rrtmgp(k)*(flwoutn_bnds(k)/flwoutn)
              enddo   
              !flw_weight1 = -emissivity_snow1*(flwoutn1/flwoutn)
              !flw_weight2 = -emissivity_snow2*(flwoutn2/flwoutn)
              !flw_weight3 = -emissivity_snow3*(flwoutn3/flwoutn)
              !flw_weight4 = -emissivity_snow4*(flwoutn4/flwoutn)
              !flw_weight5 = -emissivity_snow5*(flwoutn5/flwoutn)
              !flw_weight6 = -emissivity_snow6*(flwoutn6/flwoutn)
              !flw_weight7 = -emissivity_snow7*(flwoutn7/flwoutn)
              !flw_weight8 = -emissivity_snow8*(flwoutn8/flwoutn)
              !flw_weight9 = -emissivity_snow9*(flwoutn9/flwoutn)
              !flw_weight10 =-emissivity_snow10*(flwoutn10/flwoutn)
              !flw_weight11 =-emissivity_snow11*(flwoutn11/flwoutn)
              !flw_weight12 =-emissivity_snow12*(flwoutn12/flwoutn)
              !flw_weight13 =-emissivity_snow13*(flwoutn13/flwoutn)
              !flw_weight14 =-emissivity_snow14*(flwoutn14/flwoutn)
              !flw_weight15 =-emissivity_snow15*(flwoutn15/flwoutn)
              !flw_weight16 = -emissivity_snow16*(flwoutn16/flwoutn)
          else
               do k=1, lw_nbd
                 flw_weight_bnds(k) = -ice_emissivity_rrtmgp(k)*(flwoutn_bnds(k)/flwoutn)
              enddo  
              !flw_weight1 = -emissivity_ice1*(flwoutn1/flwoutn)
              !flw_weight2 = -emissivity_ice2*(flwoutn2/flwoutn)
              !flw_weight3 = -emissivity_ice3*(flwoutn3/flwoutn)
              !flw_weight4 = -emissivity_ice4*(flwoutn4/flwoutn)
              !flw_weight5 = -emissivity_ice5*(flwoutn5/flwoutn)
              !flw_weight6 = -emissivity_ice6*(flwoutn6/flwoutn)
              !flw_weight7 = -emissivity_ice7*(flwoutn7/flwoutn)
              !flw_weight8 = -emissivity_ice8*(flwoutn8/flwoutn)
              !flw_weight9 = -emissivity_ice9*(flwoutn9/flwoutn)
              !flw_weight10 =-emissivity_ice10*(flwoutn10/flwoutn)
              !flw_weight11 =-emissivity_ice11*(flwoutn11/flwoutn)
              !flw_weight12 =-emissivity_ice12*(flwoutn12/flwoutn)
              !flw_weight13 =-emissivity_ice13*(flwoutn13/flwoutn)
              !flw_weight14 =-emissivity_ice14*(flwoutn14/flwoutn)
              !flw_weight15 =-emissivity_ice15*(flwoutn15/flwoutn)
              !flw_weight16 = -emissivity_ice16*(flwoutn16/flwoutn)
          endif   
          !emiss_weight = flw_weight1+flw_weight2+flw_weight3+flw_weight4+flw_weight5+&
          !flw_weight6+flw_weight7+flw_weight8+flw_weight9+flw_weight10+flw_weight11+&
          !flw_weight12+flw_weight13+flw_weight14+flw_weight15+flw_weight16
          emiss_weight = SUM(flw_weight_bnds)
          dflwoutn_dTsf = emiss_weight*stefan_boltzmann*c4*TsfK**3 
          
          dflwoutn_dTsf_old = -emissivity * stefan_boltzmann * c4*TsfK**3
          l_stop = dflwoutn_dTsf - dflwoutn_dTsf_old > 1e-2_dbl_kind .or. dflwoutn_dTsf - dflwoutn_dTsf_old  < -1e-2_dbl_kind
          !if (l_stop) then
             !write(warning, *) 'Thermo Error: outgoing derivative', dflwoutn_dTsf - dflwoutn_dTsf_old 
             !call add_warning(warning)
          
          !endif  
          
      else if (longwave=='rrtmgp') then 
              if (l_snow) then
               do k=1, lw_nbd
                 flw_weight_bnds(k) = -snow_emissivity_rrtmgp(k)*(flwoutn_bnds(k)/flwoutn)
              enddo 
              !flw_weight1 = -emissivity_snow1_gp*(flwoutn1/flwoutn)
              !flw_weight2 = -emissivity_snow2_gp*(flwoutn2/flwoutn)
              !flw_weight3 = -emissivity_snow3*(flwoutn3/flwoutn)
              !flw_weight4 = -emissivity_snow4*(flwoutn4/flwoutn)
              !flw_weight5 = -emissivity_snow5*(flwoutn5/flwoutn)
              !flw_weight6 = -emissivity_snow6*(flwoutn6/flwoutn)
              !flw_weight7 = -emissivity_snow7*(flwoutn7/flwoutn)
              !flw_weight8 = -emissivity_snow8*(flwoutn8/flwoutn)
              !flw_weight9 = -emissivity_snow9*(flwoutn9/flwoutn)
              !flw_weight10 =-emissivity_snow10*(flwoutn10/flwoutn)
              !flw_weight11 =-emissivity_snow11*(flwoutn11/flwoutn)
              !flw_weight12 =-emissivity_snow12*(flwoutn12/flwoutn)
              !flw_weight13 =-emissivity_snow13*(flwoutn13/flwoutn)
              !flw_weight14 =-emissivity_snow14*(flwoutn14/flwoutn)
              !flw_weight15 =-emissivity_snow15_gp*(flwoutn15/flwoutn)
              !flw_weight16 = -emissivity_snow16_gp*(flwoutn16/flwoutn)
          else
               do k=1, lw_nbd
                 flw_weight_bnds(k) = -ice_emissivity_rrtmgp(k)*(flwoutn_bnds(k)/flwoutn)
              enddo 
              !flw_weight1 = -emissivity_ice1_gp*(flwoutn1/flwoutn)
              !flw_weight2 = -emissivity_ice2*(flwoutn2/flwoutn)
              !flw_weight3 = -emissivity_ice3*(flwoutn3/flwoutn)
              !flw_weight4 = -emissivity_ice4*(flwoutn4/flwoutn)
              !flw_weight5 = -emissivity_ice5*(flwoutn5/flwoutn)
              !flw_weight6 = -emissivity_ice6*(flwoutn6/flwoutn)
              !flw_weight7 = -emissivity_ice7*(flwoutn7/flwoutn)
              !flw_weight8 = -emissivity_ice8*(flwoutn8/flwoutn)
              !flw_weight9 = -emissivity_ice9*(flwoutn9/flwoutn)
              !lw_weight10 =-emissivity_ice10*(flwoutn10/flwoutn)
              !flw_weight11 =-emissivity_ice11*(flwoutn11/flwoutn)
              !flw_weight12 =-emissivity_ice12*(flwoutn12/flwoutn)
              !flw_weight13 =-emissivity_ice13*(flwoutn13/flwoutn)
              !flw_weight14 =-emissivity_ice14*(flwoutn14/flwoutn)
              !flw_weight15 =-emissivity_ice15_gp*(flwoutn15/flwoutn)
              !flw_weight16 = -emissivity_ice16_gp*(flwoutn16/flwoutn)
          endif   
          emiss_weight = SUM(flw_weight_bnds)
          !emiss_weight = flw_weight1+flw_weight2+flw_weight3+flw_weight4+flw_weight5+&
          !flw_weight6+flw_weight7+flw_weight8+flw_weight9+flw_weight10+flw_weight11+&
          !flw_weight12+flw_weight13+flw_weight14+flw_weight15+flw_weight16
              
          dflwoutn_dTsf = emiss_weight*stefan_boltzmann*c4*TsfK**3 
          dflwoutn_dTsf_old = -emissivity * stefan_boltzmann * c4*TsfK**3
          l_stop = dflwoutn_dTsf - dflwoutn_dTsf_old > 1e-2_dbl_kind .or. dflwoutn_dTsf - dflwoutn_dTsf_old  < -1e-2_dbl_kind
          !if (l_stop) then
          !   write(warning, *) 'Thermo Error: outgoing derivative', dflwoutn_dTsf - dflwoutn_dTsf_old 
          !  call add_warning(warning)
          
         ! endif  
      else 
          dflwoutn_dTsf = -emissivity * stefan_boltzmann * c4*TsfK**3
      endif 
      
      ! downward latent and sensible heat fluxes
      dfsensn_dTsf = -shcoef
      dflatn_dTsf  = -lhcoef * dQsfc_dTsf
    
      ! combine fluxes
      dfsurfn_dTsf = dflwoutn_dTsf + dfsensn_dTsf + dflatn_dTsf
    
      end subroutine dsurface_heat_flux_dTsf

!=======================================================================

      end module ice_therm_shared

!=======================================================================
